from itertools import product

from intcode.intcode import Intcode


class TractorBeamDrone(object):
    def __init__(self, mem_str: str):
        self._processor = Intcode(mem_str, 'Tractor Beam Drone')
        self.x_offset = 0
        self.y_offset = 0
        self.block_size = (50, 50)
        self.grid = [[0 for _ in range(self.block_size[0])] for _ in range(self.block_size[1])]

    def reset_core(self):
        self._processor.reset_core()

    def rest_grid(self):
        self.grid = [[0 for _ in range(self.block_size[0])] for _ in range(self.block_size[1])]

    def run(self, inputs=None, trace=False):
        if inputs is None:
            inputs = [0, 0]
        self._processor.simulate(inputs, trace=trace, verbose=False)
        return self._processor.output[0]

    def dispatch_bot(self, target_x, target_y, trace=False):
        self.reset_core()
        return self.run([target_x, target_y], trace=trace)

    def display(self):
        print(f'Top left @ ({self.x_offset}, {self.y_offset})')
        for y in range(self.block_size[1]):
            line = ''.join(['.' if self.grid[x][y] == 0 else '#' for x in range(self.block_size[0])])

            print(f'{line} {y + self.y_offset}')
        print(f'Bottom right @ ({self.x_offset + self.block_size[0] - 1}, {self.y_offset + self.block_size[1] - 1})')

    def count_affected(self):
        return sum(self.grid[x][y] for x, y in product(range(50), range(50)))

    def scan_block(self, x_offset=0, y_offset=0, block_size_x=50, block_size_y=50):
        self.x_offset = x_offset
        self.y_offset = y_offset
        self.block_size = (block_size_x, block_size_y)
        self.rest_grid()
        start_col = 0
        end_col = block_size_x

        for y in range(block_size_y):
            influenced_at = []
            for x in range(start_col, end_col):
                out = self.dispatch_bot(x + x_offset, y + y_offset, trace=False)
                if out == 1:
                    influenced_at.append(x)
                self.grid[x][y] = out
            if len(influenced_at) == 0:
                start_col = 0
                end_col = block_size_x
            else:
                start_col = max(0, min(influenced_at))
                end_col = min(block_size_x, max(influenced_at) + 2)
        return start_col, end_col

    def zigzag_scan(self, start_x, start_y):
        # make sure that we're starting inside the 'snake'
        if self.dispatch_bot(start_x, start_y) != 1:
            raise ValueError('Zigzag must begin inside signal snake.')
        # scan to the edge of the snake
        while self.dispatch_bot(start_x + 1, start_y) == 1:
            start_x += 1
        # now zigzag down the right hand side of the snake until
        # we get a signal at (-99,99)
        while True:
            if self.dispatch_bot(start_x, start_y) == 1:
                if self.dispatch_bot(start_x - 99, start_y + 99) == 1:
                    # print(f'zigzag ended at ({start_x}, {start_y})')
                    return start_x, start_y
                else:
                    start_x += 1
            else:
                start_y += 1


if __name__ == '__main__':
    with open('input') as f:
        mem_code = f.read()

    computer = TractorBeamDrone(mem_code)

    first, last = computer.scan_block(0, 0)
    computer.display()

    print(f'Part 1: {computer.count_affected()}')
    ''' Part 1: 211 '''

    location = computer.zigzag_scan(800, 900)

    # for n in range(12):
    #     computer.scan_block(location[0] + 10*n - 10, location[1] + 10*n - 10, 10, 10)
    #     computer.display()

    print(f'Part 2: {(location[0] - 99) * 10000 + location[1]}')

    '''
    #................................................. 0
    ..................................................
    ..................................................
    ..................................................
    ...#..............................................
    ....#.............................................
    .....#............................................
    ......#...........................................
    ......##..........................................
    .......##.........................................
    ........##........................................ 10
    .........#........................................
    .........##.......................................
    ..........##......................................
    ...........##.....................................
    ...........###....................................
    ............###...................................
    .............###..................................
    ..............###.................................
    ..............####................................
    ...............####............................... 20
    ................###...............................
    .................###..............................
    .................####.............................
    ..................####............................
    ...................####...........................
    ...................#####..........................
    ....................#####.........................
    .....................#####........................
    ......................#####.......................
    ......................######...................... 30
    .......................#####......................
    ........................#####.....................
    .........................#####....................
    .........................######...................
    ..........................######..................
    ...........................######.................
    ............................######................
    ............................#######...............
    .............................#######..............
    ..............................#######............. 40
    ..............................#######.............
    ...............................#######............
    ................................#######...........
    .................................#######..........
    .................................########.........
    ..................................########........
    ...................................########.......
    ....................................########..    5         6         7         8
    ....................................#########.6789012345678901234567890123456789012345
    0         1         2         3     .#########........................................ 50
    012345678901234567890123456789013245..########........................................
                                        ..#########.......................................
                                        ...#########......................................
                                        ....#########.....................................
                                        .....#########....................................
                                        .....##########...................................
                                        ......##########..................................
                                        .......##########.................................
                                        ........##########................................
                                     60 ........###########...............................
                                        .........##########...............................
                                        ..........##########..............................
                                        ...........##########.............................
                                        ...........###########............................
                                        ............###########...........................
                                        .............###########..........................
                                        .............############.........................
                                        ..............############........................
                                        ...............############.......................
                                     70 ................############......................
                                        ................############......................
                                        .................############.....................
                                        ..................############....................
                                        ...................############...................
                                        ...................#############..................
                                        ....................#############.................
                                        .....................#############................
                                        .....................##############...............
                                        ......................##############..............
                                     80 .......................##############.....................................
                                        ........................#############.....................................
                                        ........................##############....................................
                                        .........................##############...................................
                                        ..........................##############..................................
                                        ...........................##############.................................
                                        ...........................###############................................
                                        ............................###############...............................
                                        .............................###############..............................
                                        .............................################.............................
                                     90 ..............................################............................
                                        ...............................################...........................
                                        ................................###############...........................
                                        ................................################..........................
                                        .................................################.........................
                                        ..................................################........................
                                        ...................................################.......................
                                        ...................................#################...         1        1
                                        ....................................#################..         0        0
                                     99 .....................................#################.1234567890123456789
                                    100     4         5         6         7  .#################...................
                                            012345678901234567890123456789012.##################..................
                                                                ...............#################..................
                                                                ................#################.................
                                                            104 ................##################................
                                                                .................##################...............
                                                                ..................##################..............
                                                                ...................##################.............
                                                                ...................###################............
                                                                ....................###################...........
                                                            110 .....................###################..........
                                                                ......................###################.........
                                                                ......................###################.........
                                                                .......................###################........
                                                                ........................###################.......
                                                                ........................####################......
                                                                .........................####################.....
                                                                ..........................####################....
                                                                ...........................####################...
                                                                ...........................#####################..
                                                            120 ............................#####################.
                                                                .............................#####################
                                                                ..............................####################
                                                                ..............................####################
                                                                ...............................###################
                                                                ................................##################
                                                                .................................#################
                                                                .................................#################
                                                                ..................................################
                                                            129 ...................................###############



    Part 1: 211
    Part 2: 8071006
    '''
